# Agent Skills 三层渐进式披露工作流（总结）

## 第一阶段：技能发现 (Skill Discovery)
**目的**：在 16 个技能库里"海选"出最匹配的那一个。

| 动作 | 详情 | Token 效率 |
| :--- | :--- | :--- |
| **加载元数据** | 仅提取每个技能的 `name` 和 `description`（前 150 字） | ~100 tokens/技能 |
| **构建 Prompt** | 把 16 个技能的简介组装成一个"单选题" | - |
| **LLM 决策** | 发送给 LLM，要求它回复一个单次（技能名称） | 极低消耗 |
| **结果** | LLM 选出最匹配的技能（如 `frontend-design`） | - |

### 🔍 日志关键点
- `[SKILL DISCOVERY PROMPT START/END]`：完整展示发送给 LLM 的技能列表。
- `LLM 原始决策输出`：LLM 返回的原始字符串。
- `🎯 最终命中技能`：代码匹配成功后的本地物理路径。

---

## 第二阶段：指令加载 (Instruction Loading)
**目的**：只加载被选中的那个技能的详细说明书，按需读取。

| 动作 | 详情 |
| :--- | :--- |
| **读取主文档** | 读取选定技能目录下的 `SKILL.md` 全文。 |
| **扫描引用** | 检查指令中是否有 `Read [`xxx.md`]` 模式的强制技术文档引用。 |
| **合并上下文** | 如果发现关联文档（如 `ooxml.md`），自动将其内容追加。 |
| **构建完成** | 计算并输出最终组装后的指令集总长度。 |

### 📂 日志关键点
- `📁 技能根目录`、`📄 主指令文件`：展示具体加载的文件路径。
- `🔍 扫描关联文档引用...`：展示是否发现了额外的 Layer 3 资源需求。
- `✅ [LOADER] 指令集构建完成`：反馈最终注入 LLM 的知识库总量。

---

## 第三阶段：执行生成 (Execution)
**目的**：把完整的 SOP（说明书）喂给 LLM，让它生成并运行 Python 代码。

| 动作 | 详情 |
| :--- | :--- |
| **构建 Prompt** | 将完整的 SOP 指令与用户具体任务合并。 |
| **流式输出** | LLM 边生成边打印到控制台，实现“打字机”实时反馈。 |
| **代码提取** | 使用正则精准抓取 ` ```python ` 代码块。 |
| **本地执行** | 保存为 `temp_skill_script.py` 并通过子进程安全运行。 |
| **重试机制** | 若运行报错，截获 `stderr` 发回 LLM 进行自修复（最多 3 次）。 |

### 🚀 日志关键点
- `[FULL LLM PROMPT START/END]`：展示喂给 LLM 的几千字详细技术规范。
- `[LLM OUTPUT - Attempt N]`：实时展示代码生成过程。
- `⚙️ [ENVIRONMENT SETUP]`：展示动态注入的 `PYTHONPATH` 环境变量。
- `[EXECUTION RESULT]`：展示最终的执行成功状态或错误追溯。

---

## 架构总结图

```text
           [ 用户输入 ] (如: "写一个登录页面")
                 |
                 v
    +---------------------------------------+
    |  第一阶段: DISCOVERY (LLM 匹配)         |
    |  (输入: 16个技能摘要 -> LLM 决策)       |
    +---------------------------------------+
                 |
                 | (命中: frontend-design)
                 v
    +---------------------------------------+
    |  第二阶段: LOADING (本地读取)           |
    |  (读取 SKILL.md + 关联技术文档)         |
    +---------------------------------------+
                 |
                 v
    +---------------------------------------+ <-------+
    |  第三阶段: EXECUTION (生成与执行)       |         |
    |  (LLM 生成 Python 代码)                 |         |
    +---------------------------------------+         |
                 |                                    |
                 v                                    |
    +---------------------------------------+         |
    |  本地环境运行 (temp_skill_script.py)   |         |
    +---------------------------------------+         |
                 |           |                        |
                 | [成功]    | [报错反馈]              |
                 v           +------------------------+
    +---------------------------------------+
    |  输出产物 (如: login.html)              |
    +---------------------------------------+
```

> **结语**：这就是 Anthropic Agent Skills 标准的完整实现！你现在拥有了一个结构清晰、高度可观测、并能自我纠错的智能体执行引擎。
